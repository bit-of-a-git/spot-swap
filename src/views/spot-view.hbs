{{> welcome-menu active="spots"}}
<div class="box has-background-black-ter has-text-white-ter">
  <div class="columns">
    <div class="column is-one-fifth">{{> counties-selector}}</div>
    <div class="column is-one-fifth">{{>categories-selector}}</div>
  </div>
  <div id="spotsContainer">
    {{#if spots.length }}
      {{#each spots }}
        <section class="section">
          <div class="title has-text-white-ter">{{name}}</div>
          <div class="subtitle is-6 has-text-warning">{{category}}</div>
          <div class="column">{{description}}</div>
          {{#if img }}
            <div class="columns">
              <div class="column is-half">{{>map}}</div>
              <div class="column is-half">
                <div class="card-image">
                  <figure class="image is-256x256">
                    <img src={{img}}>
                  </figure>
                </div>
              </div>
            </div>
          {{else}}
            {{>map}}
          {{/if}}
        </section>
      {{/each}}
    {{else}}
      <div class="title has-text-white-ter">No Spots in Category</div>
    {{/if}}
  </div>
</div>
<script>
  document.getElementById("categoryFilter").addEventListener("change", updateSpots);
  document.getElementById("countyFilter").addEventListener("change", updateSpots);

  async function updateSpots() {
    const selectedCategory = document.getElementById("categoryFilter").value;
    const selectedCounty = document.getElementById("countyFilter").value;
    const url = new URL(window.location.href);
    if (selectedCategory) {
      url.searchParams.set("category", selectedCategory);
    } else {
      url.searchParams.delete("category");
    }
    if (selectedCounty) {
      url.searchParams.set("county", selectedCounty);
    } else {
      url.searchParams.delete("county");
    }

    const response = await fetch(url.toString(), {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    });
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newSpotsContainer = doc.getElementById("spotsContainer");
    document.getElementById("spotsContainer").innerHTML = newSpotsContainer.innerHTML;
    initialiseMaps();
  }

  function initialiseMaps() {
    document.querySelectorAll('[id^="map-"]').forEach((mapElement, index) => {
      const name = mapElement.getAttribute('name');
      const latitude = mapElement.getAttribute('latitude');
      const longitude = mapElement.getAttribute('longitude');

      let map = L.map(mapElement.id).setView([latitude, longitude], 13);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        minZoom: 2,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      let marker = L.marker([latitude, longitude]).addTo(map);
      marker.bindPopup(`<b>${name}</b><br>Lat: ${latitude}, Long: ${longitude}`);
    });
  }

  document.addEventListener("DOMContentLoaded", initialiseMaps);
</script>
